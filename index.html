<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    
    <!-- =================================================================== -->
    <!-- META-DONN√âES OPTIMIS√âES POUR UNE EXP√âRIENCE NATIVE SUR iOS          -->
    <!-- =================================================================== -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PIONPION">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"> 
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e0e5ec">

    <title>PIONPION - Projet: ASCENSION v4.0 (Refonte iOS)</title>
    
    <style>
        /* =================================================================== */
        /* DIRECTION ARTISTIQUE V4.0 : "FLUID UI" & PERFORMANCES iOS         */
        /* CSS 100% repens√© pour la fluidit√©, la disposition et l'ergonomie. */
        /* Couleurs originales conserv√©es.                                  */
        /* =================================================================== */
        :root {
            /* Palette de couleurs "Neumorphisme Doux" (INCHANG√âE) */
            --bg-color: #e0e5ec;
            --accent-color: #007aff; 
            --x-color: #ff3b30;     
            --o-color: #34c759;     
            --text-color: #5a6473;
            --text-light-color: #9ba6b8;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --bronze: #cd7f32; --silver: #c0c0c0; --gold: #ffd700;
            
            /* Zones de s√©curit√© de l'iPhone (encoche, barre d'accueil) */
            --safe-area-inset-top: env(safe-area-inset-top, 20px);
            --safe-area-inset-right: env(safe-area-inset-right, 20px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 20px);
            --safe-area-inset-left: env(safe-area-inset-left, 20px);
        }

        /* Importation de la police "Inter", parfaite pour les UI modernes */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        /* Reset et am√©liorations globales */
        * { 
            box-sizing: border-box; 
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif; 
        }
        html {
            -webkit-text-size-adjust: 100%;
        }

        /* NOUVEAU BODY : Layout vertical, optimis√© pour les t√©l√©phones */
        body { 
            background-color: var(--bg-color);
            color: var(--text-color); 
            height: 100dvh; /* Hauteur dynamique du viewport */
            margin: 0; 
            overflow: hidden; /* Emp√™che le scroll global */
            display: flex;
            flex-direction: column;
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
        }
        
        /* NOUVEAUX √âCRANS & TRANSITIONS FLUIDES (SLIDE + FADE) */
        .screen {
            flex-grow: 1; /* Prend l'espace disponible */
            display: flex;
            flex-direction: column;
            width: 100%;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            will-change: opacity, transform;
            overflow: hidden; /* Cache le contenu qui d√©passe */
        }
        .screen.hidden {
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
            position: absolute; /* Permet la superposition pendant la transition */
            top: 0; left: 0;
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
        }

        /* NOUVEL √âCRAN DE LANCEMENT : Centr√© et √©pur√© */
        #launch-screen {
            justify-content: center;
            align-items: center;
            gap: 2rem;
            text-align: center;
        }
        #launch-screen .logo {
            font-weight: 800;
            font-size: clamp(4rem, 20vmin, 8rem);
            color: var(--text-light-color);
            text-shadow: 2px 2px 5px var(--shadow-dark), -2px -2px 5px var(--shadow-light);
        }
        
        /* NOUVEAUX BOUTONS : Forme "Squircle" (iOS), animations l√©g√®res */
        button { 
            font-weight: 600; cursor: pointer; 
            border: none;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            border-radius: 12px; /* Style iOS */
            transition: transform 0.15s ease-out;
            padding: 16px 24px; font-size: 1.1em; margin: 8px 0;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            will-change: transform;
        }
        button:hover, button:focus-visible {
            transform: scale(1.03); /* Effet de survol subtil */
            color: var(--accent-color);
        }
        button:active {
            transform: scale(0.97); /* Effet de pression, tr√®s r√©actif */
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            transition-duration: 0.05s;
        }
        button.disabled {
            opacity: 0.6; cursor: not-allowed;
            transform: none !important; color: var(--text-light-color) !important;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light) !important;
        }
        button.text-button { /* Pour les boutons secondaires (retour, etc.) */
            box-shadow: none; background: transparent; color: var(--text-light-color); font-size: 1em; padding: 10px;
        }
        button.text-button:hover { color: var(--accent-color); transform: none; }
        button.text-button:active { background: rgba(0,0,0,0.05); transform: scale(0.98); box-shadow: none; }

        /* NOUVELLE UI FIXE : Int√©gr√©e et discr√®te */
        .fixed-ui-element {
            position: fixed;
            background: var(--bg-color);
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1.2);
        }
        .fixed-ui-element.hidden { transform: translateY(-150%); }

        #exit-fullscreen-btn {
            top: var(--safe-area-inset-top); left: var(--safe-area-inset-left);
            width: 40px; height: 40px; border-radius: 50%;
            display: grid; place-items: center;
            font-size: 2em; line-height: 1; font-weight: 300;
        }
        
        .currency-display { 
            top: var(--safe-area-inset-top); right: var(--safe-area-inset-right);
            padding: 8px 18px; border-radius: 20px; 
            font-size: 1.1em; font-weight: 600;
        }
        .currency-display.reward-pulse { animation: pulse 0.5s; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        /* STRUCTURE DES √âCRANS */
        .screen-header { padding: 0 10px; text-align: center; }
        .screen-content { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 15px 10px; }
        .screen-footer { padding: 10px; text-align: center; }
        
        h1, h2 { font-weight: 800; letter-spacing: 1px; margin: 0 0 1rem 0; color: var(--text-light-color); text-transform: uppercase; }
        h1 { font-size: clamp(2.5rem, 10vmin, 4rem); } 
        h2 { font-size: clamp(1.8rem, 8vmin, 2.5rem); }
        
        #main-menu { align-items: center; justify-content: center; text-align: center; gap: 1rem; }
        #main-menu .logo { font-size: 4rem; margin-bottom: 1rem; }
        #main-menu button { display: block; width: 100%; max-width: 320px; }
        
        /* NOUVEAU STYLE POUR LA LISTE DES D√âFIS : Plus compacte et lisible */
        .phase-header { font-weight: 800; font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; margin: 25px 0 10px; color: var(--text-light-color); }
        .challenge-item {
            display: flex; align-items: center; gap: 15px;
            background: var(--bg-color);
            padding: 15px; border-radius: 15px; 
            margin-bottom: 12px; cursor: pointer;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            transition: transform 0.2s ease;
        }
        .challenge-item:not(.locked):hover { transform: scale(1.02); }
        .challenge-item.locked { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .challenge-id { font-weight: 800; font-size: 1.8em; color: var(--accent-color); flex-shrink: 0; }
        .challenge-info { flex-grow: 1; text-align: left; }
        .challenge-info small { color: var(--text-light-color); }
        .challenge-medals-display { font-size: 1.2em; display: flex; gap: 4px; }
        .challenge-medals-display .medal { opacity: 0.2; transition: all 0.3s; }
        .challenge-medals-display .medal.bronze { color: var(--bronze); opacity: 1; }
        .challenge-medals-display .medal.silver { color: var(--silver); opacity: 1; }
        .challenge-medals-display .medal.gold { color: var(--gold); opacity: 1; }

        #challenge-objective { background: rgba(0,0,0,0.02); padding: 12px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9em; border-left: 3px solid var(--accent-color); box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light); }
        
        /* NOUVEAU PLATEAU DE JEU : Cases circulaires */
        #game-wrapper { text-align: center; justify-content: space-between; }
        #board {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            margin: 0 auto; width: clamp(280px, 85vmin, 380px); aspect-ratio: 1 / 1;
            padding: 15px; border-radius: 20px;
            box-shadow: inset 8px 8px 16px var(--shadow-dark), inset -8px -8px 16px var(--shadow-light);
        }
        .cell {
            background-color: var(--bg-color);
            border-radius: 50%; /* Cases rondes */
            display: grid; place-items: center;
            font-size: clamp(2.5em, 15vmin, 4em); font-weight: 800;
            cursor: pointer;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .cell:not(.x):not(.o):hover { transform: scale(1.05); }
        .cell:not(.x):not(.o):active {
            transform: scale(0.95);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .pion { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s; will-change: transform, opacity; }
        .cell.x, .cell.o {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            cursor: default;
        }
        .cell.x .pion { color: var(--x-color); }
        .cell.o .pion { color: var(--o-color); }
        /* NOUVELLE ANIMATION FANT√îME : Pulsation d'opacit√©, plus l√©g√®re */
        .cell.ghost { animation: ghost-pulse 1.8s infinite ease-in-out; }
        @keyframes ghost-pulse { 50% { opacity: 0.5; } }
        
        /* NOUVELLE ANIMATION DE PLACEMENT : "POP" optimis√© */
        .pion.placed { animation: placePiece 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes placePiece {
            from { transform: scale(0.6); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .pion.removed { animation: removePiece 0.3s ease-out forwards; }
        @keyframes removePiece { to { opacity: 0; transform: scale(0.6); } }
        
        /* NOUVELLE ANIMATION DE VICTOIRE : Lueur sur le pion, plus performant */
        .winning-cell .pion {
            animation: highlightWin 1.2s ease-in-out infinite;
            color: white !important;
        }
        @keyframes highlightWin {
            0%, 100% { text-shadow: 0 0 5px white, 0 0 15px var(--accent-color); transform: scale(1); }
            50% { text-shadow: 0 0 10px white, 0 0 30px var(--accent-color); transform: scale(1.1); }
        }
        
        /* NOUVELLES MODALES : Animations plus rapides */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(90, 100, 115, 0.5);
            -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
            animation: fadeInModal 0.2s ease;
            padding: 20px;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: var(--bg-color); padding: 30px; border-radius: 20px; text-align: center;
            max-width: 400px; width: 100%;
            box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
            animation: modalOpen 0.4s cubic-bezier(0.2, 0.8, 0.2, 1.2);
        }
        @keyframes modalOpen { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #victory-bonus { color: var(--o-color); font-weight: bold; }
        .share-icon { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--text-color); border-radius: 4px; position: relative; margin: 0 5px; vertical-align: middle; }
        .share-icon::before { content: ''; position: absolute; bottom: 6px; left: 7px; width: 2px; height: 10px; background: var(--text-color); }
        .share-icon::after { content: ''; position: absolute; bottom: 12px; left: 4px; border-left: 3px solid transparent; border-right: 3px solid transparent; border-bottom: 5px solid var(--text-color); }
    </style>
</head>
<body>
    
    <div id="launch-screen" class="screen">
        <div class="logo">PIONPION</div>
        <div class="screen-footer">
            <button id="launch-btn">JOUER</button>
            <button id="add-to-home-btn" class="hidden text-button">Installer l'application</button>
        </div>
    </div>

    <!-- UI Fixe (boutons de sortie et monnaie) -->
    <div id="exit-fullscreen-btn" class="fixed-ui-element hidden">&times;</div>
    <div id="currency-display" class="fixed-ui-element currency-display hidden">‚ú® <span id="currency-amount">0</span></div>
    
    <!-- Menus principaux (√©crans) -->
    <div id="main-menu" class="screen hidden">
        <div class="logo">PIONPION</div>
        <button id="start-campaign-btn">Projet: ASCENSION</button>
        <button id="start-quickplay-btn">Jeu Rapide</button>
        <button id="shop-btn" class="disabled">Boutique (Bient√¥t)</button>
    </div>

    <div id="campaign-screen" class="screen hidden">
        <div class="screen-header">
            <h2>Ascension</h2>
        </div>
        <div id="campaign-list" class="screen-content"></div>
        <div class="screen-footer">
            <button class="back-to-menu text-button">Menu Principal</button>
        </div>
    </div>

    <div id="game-wrapper" class="screen hidden">
        <div class="screen-header">
            <div id="challenge-objective" class="hidden"></div>
            <div id="status" style="margin-bottom: 10px; font-size: 1.2em; font-weight: 600; height: 1.5em;"></div>
        </div>
        <div id="board-container" class="screen-content" style="display:grid; place-items:center;">
             <div id="board"></div>
        </div>
        <div class="screen-footer controls">
            <select id="level" class="hidden"></select>
            <button id="reset-btn" style="padding: 15px 30px; font-size: 1em;">Rejouer</button>
            <button class="back-btn text-button">Quitter</button>
        </div>
    </div>

    <!-- Modales (pop-ups) -->
    <div id="victory-modal" class="modal">
        <div class="modal-content">
            <h2 id="victory-title">D√©fi R√©ussi !</h2>
            <div id="victory-medals" style="font-size: 2em; margin: 10px 0;"></div>
            <p>R√©compense : <span id="victory-reward" style="font-weight: bold;"></span> ‚ú®</p>
            <p id="victory-bonus-text" class="hidden">Bonus Critique ! +<span id="victory-bonus"></span> ‚ú®</p>
            <button id="next-challenge-btn">D√©fi Suivant</button>
            <button class="back-to-campaign text-button">Retour aux D√©fis</button>
        </div>
    </div>
    
    <div id="a2hs-instructions-modal" class="modal">
        <div class="modal-content">
            <h2>Installer l'application</h2>
            <p>Pour la meilleure exp√©rience, ajoutez PIONPION √† votre √©cran d'accueil :</p>
            <p style="margin: 20px 0;">
                Appuyez sur l'ic√¥ne de partage <span class="share-icon"></span> puis s√©lectionnez<br>
                <strong>"Sur l'√©cran d'accueil"</strong>.
            </p>
            <button id="close-a2hs-modal-btn">Compris !</button>
        </div>
    </div>

    <script>
    // ===================================================================
    // JAVASCRIPT : INCHANG√â
    // La logique de jeu est conserv√©e telle quelle.
    // ===================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Le JS original √©tait d√©j√† tr√®s bien structur√©. 
        // Les modifications sont minimes et visent principalement √† s'adapter au nouveau design.
        const audioManager = {
            ctx: null, isUnlocked: false,
            init() { if (this.isUnlocked || typeof AudioContext === 'undefined') return; this.ctx = new (window.AudioContext || window.webkitAudioContext)(); this.isUnlocked = true; },
            play(type) { if (!this.isUnlocked) return; let osc = this.ctx.createOscillator(); let gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination); const now = this.ctx.currentTime; gain.gain.setValueAtTime(0.5, now); switch (type) { case 'click': osc.frequency.setValueAtTime(440, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1); break; case 'place': osc.frequency.setValueAtTime(261.63, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2); break; case 'win': osc.frequency.setValueAtTime(523.25, now); osc.frequency.linearRampToValueAtTime(1046.50, now + 0.3); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.4); break; case 'lose': osc.frequency.setValueAtTime(220, now); osc.frequency.linearRampToValueAtTime(110, now + 0.4); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.5); break; case 'coin': osc.frequency.setValueAtTime(880, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.15); break; } osc.start(now); osc.stop(now + 0.5); }
        };

        const haptics = {
            vibrate(type = 'light') {
                if ('vibrate' in navigator) {
                    try {
                        if (type === 'light') navigator.vibrate(20);
                        if (type === 'success') navigator.vibrate([50, 50, 50]);
                        if (type === 'error') navigator.vibrate(200);
                    } catch(e) { console.warn("Haptic feedback failed", e); }
                }
            }
        };

        const launchScreen = document.getElementById('launch-screen'); const launchBtn = document.getElementById('launch-btn'); const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn'); const docElem = document.documentElement;
        function openFullscreen() { if (docElem.requestFullscreen) { docElem.requestFullscreen().catch(err => console.log(err)); } else if (docElem.webkitRequestFullscreen) { docElem.webkitRequestFullscreen().catch(err => console.log(err)); } }
        function closeFullscreen() { if (document.exitFullscreen) { document.exitFullscreen(); } else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } }
        function checkFullscreenStatus() { const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement); exitFullscreenBtn.classList.toggle('hidden', !isFullscreen); }
        const screens = { launch: launchScreen, mainMenu: document.getElementById('main-menu'), campaign: document.getElementById('campaign-screen'), game: document.getElementById('game-wrapper') }; const boardElement = document.getElementById('board'), statusElement = document.getElementById('status'), levelSelect = document.getElementById('level'), resetBtn = document.getElementById('reset-btn'), currencyAmount = document.getElementById('currency-amount'), victoryModal = document.getElementById('victory-modal'), currencyDisplay = document.getElementById('currency-display'); const addToHomeBtn = document.getElementById('add-to-home-btn'); const a2hsModal = document.getElementById('a2hs-instructions-modal'); const closeA2hsModalBtn = document.getElementById('close-a2hs-modal-btn');
        let currentScreen = 'launch';
        let gameMode, currentChallengeId, currency, campaignProgress, board, moveHistory, fullMoveHistory, playerMoveCount, firstPlayerMoveIndex, currentPlayer, gameActive; const ALL_CHALLENGES = [{id:1,phase:1,title:"Initiation",objective:"Gagnez contre l'IA Facile.",difficulty:'easy',medals:{bronze:{check:w=>w.winner==='X',desc:"Gagner la partie."},silver:{check:(w,p)=>p.X<=4,desc:"Gagner en 4 coups ou moins."},gold:{check:(w,p)=>p.X<=3,desc:"Gagner en 3 coups."}},rewards:{bronze:10,silver:5,gold:10}},{id:2,phase:1,title:"Ligne de Force",objective:"Gagnez avec une ligne verticale.",difficulty:'easy',medals:{bronze:{check:w=>[[0,3,6],[1,4,7],[2,5,8]].some(l=>l.every(i=>w.line.includes(i))),desc:"Gagner avec une colonne."},silver:{check:(w,p,c)=>c.bronze&&p.X<=4,desc:"Et en 4 coups ou moins."},gold:{check:(w,p,c)=>c.silver&&!moveHistory.includes(firstPlayerMoveIndex),desc:"Et sans que votre 1er pion soit retir√©."}},rewards:{bronze:15,silver:10,gold:15}},{id:3,phase:1,title:"Ma√Ætre du Centre",objective:"Gagnez en utilisant la case centrale.",difficulty:'intermediate',medals:{bronze:{check:w=>w.line.includes(4),desc:"Gagner avec la case centrale."},silver:{check:(w,p,c)=>c.bronze&&!fullMoveHistory.some(m=>m.index===4&&m.player==='O'),desc:"Et sans que l'IA ne joue au centre."},gold:{check:(w,p,c)=>c.silver&&levelSelect.value==='intermediate',desc:"Et en difficult√© Interm√©diaire."}},rewards:{bronze:15,silver:15,gold:20}},{id:4,phase:2,title:"Intouchable",objective:"Gagnez sans que votre 1er pion soit retir√©.",difficulty:'intermediate',medals:{bronze:{check:w=>moveHistory.includes(firstPlayerMoveIndex),desc:"Votre 1er pion est toujours sur le plateau."},silver:{check:(w,p,c)=>c.bronze&&p.X<=4,desc:"Et gagner en 4 coups ou moins."},gold:{check:(w,p,c)=>c.silver&&levelSelect.value==='intermediate',desc:"Et en difficult√© Interm√©diaire."}},rewards:{bronze:20,silver:15,gold:25}},{id:5,phase:2,title:"Efficacit√© Redoutable",objective:"Gagnez en 3 coups exactement.",difficulty:'intermediate',medals:{bronze:{check:(w,p)=>p.X===3,desc:"Gagner en 3 coups."},silver:{check:(w,p,c)=>c.bronze&&w.line.includes(4),desc:"Et en utilisant la case centrale."},gold:{check:(w,p,c)=>c.silver&&levelSelect.value==='hard',desc:"Et en difficult√© Difficile."}},rewards:{bronze:25,silver:25,gold:50}},{id:6,phase:2,title:"Le Puzzle du Coin",objective:"L'IA a mal jou√©. Gagnez au prochain coup.",difficulty:'easy',preset:{board:['O',null,null,null,'X',null,null,null,'O'],turn:'X'},medals:{bronze:{check:(w,p)=>p.X===1,desc:"Gagner en un seul coup."},silver:{check:(w,p,c)=>c.bronze,desc:" "},gold:{check:(w,p,c)=>c.bronze,desc:" "}},rewards:{bronze:30,silver:0,gold:0}},{id:7,phase:3,title:"Le Grand Test",objective:"Gagnez contre l'IA en Difficile.",difficulty:'hard',medals:{bronze:{check:w=>levelSelect.value==='hard',desc:"Gagner contre l'IA Difficile."},silver:{check:(w,p,c)=>c.bronze&&p.X<=5,desc:"Et en 5 coups ou moins."},gold:{check:(w,p,c)=>c.silver&&moveHistory.includes(firstPlayerMoveIndex),desc:"Et sans que votre 1er pion soit retir√©."}},rewards:{bronze:50,silver:50,gold:100}}];
        
        function init() {
            loadData(); createBoardCells();
            const isIos = () => /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
            if (isIos() && !isInStandaloneMode()) { addToHomeBtn.classList.remove('hidden'); }
            launchBtn.addEventListener('click', () => { if(!isInStandaloneMode()) openFullscreen(); audioManager.init(); haptics.vibrate('light'); launchScreen.classList.add('hidden'); setTimeout(() => { showScreen('mainMenu'); currencyDisplay.classList.remove('hidden'); }, 300); });
            addToHomeBtn.addEventListener('click', () => openModal(a2hsModal)); closeA2hsModalBtn.addEventListener('click', () => closeModal(a2hsModal));
            exitFullscreenBtn.addEventListener('click', closeFullscreen); document.addEventListener('fullscreenchange', checkFullscreenStatus); document.addEventListener('webkitfullscreenchange', checkFullscreenStatus);
            boardElement.addEventListener('click', handleBoardClick); document.querySelectorAll('button').forEach(b => b.addEventListener('click', () => { audioManager.play('click'); haptics.vibrate('light'); })); document.getElementById('start-campaign-btn').addEventListener('click', showCampaignScreen); document.getElementById('start-quickplay-btn').addEventListener('click', startQuickPlay); document.querySelectorAll('.back-to-menu').forEach(b => b.addEventListener('click', () => showScreen('mainMenu'))); document.querySelectorAll('.back-btn').forEach(b => b.addEventListener('click', () => gameMode === 'campaign' ? showCampaignScreen() : showScreen('mainMenu'))); document.querySelector('.back-to-campaign').addEventListener('click', ()=>{closeModal(victoryModal); showCampaignScreen();}); document.getElementById('next-challenge-btn').addEventListener('click', ()=>{closeModal(victoryModal); startChallenge(currentChallengeId+1);}); resetBtn.addEventListener('click', () => gameMode === 'campaign' ? startChallenge(currentChallengeId) : startQuickPlay());
        }
        
        function showScreen(screenName) {
            const oldScreen = screens[currentScreen];
            if (oldScreen) oldScreen.classList.add('hidden');
            const newScreen = screens[screenName];
            if (newScreen) newScreen.classList.remove('hidden');
            currentScreen = screenName;
            const showCurrency = screenName === 'campaign' || screenName === 'mainMenu';
            currencyDisplay.classList.toggle('hidden', !showCurrency);
        }

        function openModal(modal) { modal.style.display = 'flex'; }
        function closeModal(modal) { modal.style.display = 'none'; }
        function showCampaignScreen() { const list = document.getElementById('campaign-list'); list.innerHTML = ''; let lastPhase = 0; ALL_CHALLENGES.forEach(challenge => { if (challenge.phase > lastPhase) { const header = document.createElement('div'); header.className = 'phase-header'; header.textContent = `PHASE ${challenge.phase}`; list.appendChild(header); lastPhase = challenge.phase; } let progress = campaignProgress.find(p => p.id === challenge.id); if (!progress) { progress = { id: challenge.id, unlocked: challenge.id === 1, medal: 0 }; campaignProgress.push(progress); } progress.unlocked = progress.id === 1 || (campaignProgress.find(p => p.id === challenge.id - 1)?.medal > 0); const item = document.createElement('div'); item.className = 'challenge-item'; if (!progress.unlocked) item.classList.add('locked'); item.innerHTML = ` <div class="challenge-id">${challenge.id}</div> <div class="challenge-info"> <div>${challenge.title}</div> <small>${challenge.objective}</small> </div> <div class="challenge-medals-display">${getMedalHTML(progress.medal)}</div>`; if (progress.unlocked) item.addEventListener('click', () => startChallenge(challenge.id)); list.appendChild(item); }); showScreen('campaign'); }
        function getMedalHTML(tier) { let html = '<span class="medal">ü•â</span><span class="medal">ü•à</span><span class="medal">ü•á</span>'; if(tier>=1) html=html.replace('class="medal"','class="medal bronze"'); if(tier>=2) html=html.replace('class="medal"','class="medal silver"'); if(tier>=3) html=html.replace('class="medal"','class="medal gold"'); return html; }
        function saveData() { localStorage.setItem('pionpion_ascension_data', JSON.stringify({ currency, campaignProgress })); updateCurrencyDisplay(); }
        function loadData() { const d = JSON.parse(localStorage.getItem('pionpion_ascension_data')); if(d) { currency = d.currency || 0; campaignProgress = d.campaignProgress || []; } else { currency = 0; campaignProgress = []; } updateCurrencyDisplay(); }
        function updateCurrencyDisplay(animate = false) { currencyAmount.textContent = currency; if (animate) { currencyDisplay.classList.add('reward-pulse'); setTimeout(() => currencyDisplay.classList.remove('reward-pulse'), 500); } }
        function startQuickPlay() { gameMode = 'quickplay'; document.getElementById('challenge-objective').classList.add('hidden'); levelSelect.value = 'intermediate'; startNewRound(); showScreen('game'); }
        function startChallenge(id) { const challenge = ALL_CHALLENGES.find(c => c.id === id); if (!challenge) return; gameMode = 'campaign'; currentChallengeId = id; const o = document.getElementById('challenge-objective'); o.textContent = `Objectif: ${challenge.objective}`; o.classList.remove('hidden'); levelSelect.value = challenge.difficulty; startNewRound(challenge.preset); showScreen('game'); }
        function endGame(winnerInfo) { gameActive = false; if (winnerInfo.winner === 'X') { audioManager.play('win'); haptics.vibrate('success'); statusElement.textContent = `Vous avez gagn√© !`; winnerInfo.line.forEach(i => boardElement.children[i].classList.add('winning-cell')); if (gameMode === 'campaign') { handleCampaignVictory(winnerInfo); } } else { audioManager.play('lose'); haptics.vibrate('error'); statusElement.textContent = `Vous avez perdu !`; if(winnerInfo.line) winnerInfo.line.forEach(i => boardElement.children[i].classList.add('winning-cell')); } }
        function handleCampaignVictory(winnerInfo) { const challenge = ALL_CHALLENGES.find(c => c.id === currentChallengeId); let progress = campaignProgress.find(p => p.id === currentChallengeId); const oldMedalTier = progress.medal; const cond = { bronze: challenge.medals.bronze.check(winnerInfo, playerMoveCount), silver: false, gold: false }; if (cond.bronze) cond.silver = challenge.medals.silver.check(winnerInfo, playerMoveCount, cond); if (cond.silver) cond.gold = challenge.medals.gold.check(winnerInfo, playerMoveCount, cond); let newMedalTier = 0; if(cond.gold) newMedalTier=3; else if(cond.silver) newMedalTier=2; else if(cond.bronze) newMedalTier=1; if (newMedalTier > oldMedalTier) { let reward = 0; if (newMedalTier >= 1 && oldMedalTier < 1) reward += challenge.rewards.bronze; if (newMedalTier >= 2 && oldMedalTier < 2) reward += challenge.rewards.silver; if (newMedalTier >= 3 && oldMedalTier < 3) reward += challenge.rewards.gold; let bonus = 0; if (Math.random() < 0.15) { bonus = Math.floor(reward * 0.5); } progress.medal = newMedalTier; showVictoryModal(challenge, newMedalTier, reward, bonus); } }
        function showVictoryModal(c, tier, reward, bonus) { document.getElementById('victory-title').textContent = c.title + " - R√©ussi !"; document.getElementById('victory-medals').innerHTML = getMedalHTML(tier); document.getElementById('victory-reward').textContent = reward; const bonusText = document.getElementById('victory-bonus-text'); if (bonus > 0) { document.getElementById('victory-bonus').textContent = bonus; bonusText.classList.remove('hidden'); } else { bonusText.classList.add('hidden'); } const nextChallenge = ALL_CHALLENGES.find(ch => ch.id === c.id + 1); let isNextUnlocked = false; if (nextChallenge) { const nextProgress = campaignProgress.find(p=>p.id === nextChallenge.id); isNextUnlocked = !nextProgress || nextProgress.unlocked; } document.getElementById('next-challenge-btn').classList.toggle('hidden', !nextChallenge || !isNextUnlocked); setTimeout(() => { openModal(victoryModal); animateCurrencyGain(reward + bonus, document.getElementById('victory-reward')); }, 1200); }
        function animateCurrencyGain(amount, originElement) { if (amount <= 0) return; /* L'animation de gain de monnaie a √©t√© simplifi√©e pour ce design. */ setTimeout(() => { currency += amount; saveData(); updateCurrencyDisplay(true); audioManager.play('coin'); }, 300); }
        const winningConditions = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; function createBoardCells(){if(boardElement.children.length>0)return;for(let i=0;i<9;i++){const c=document.createElement('div');c.classList.add('cell');c.dataset.index=i;boardElement.appendChild(c);}} function handleBoardClick(e){const c=e.target.closest('.cell');if(!c||!gameActive||currentPlayer!=='X'||board[parseInt(c.dataset.index)])return;runPlayerTurn(parseInt(c.dataset.index));} function runPlayerTurn(i){placePiece(i,'X');const w=checkWinner();if(w){endGame(w);return;}removeOldestPieceIfNeeded();switchPlayer();if (gameActive) setTimeout(computerMove,500);} function computerMove(){if(!gameActive)return;let m;const d=levelSelect.value;if(d==='easy')m=getEasyMove();else if(d==='intermediate')m=getIntermediateMove();else m=getHardMove();if(m!==-1){placePiece(m,'O');const w=checkWinner();if(w){endGame(w);return;}removeOldestPieceIfNeeded();}else{gameActive=false;statusElement.textContent='√âgalit√© !';}switchPlayer();} function placePiece(i,p){board[i]=p;moveHistory.push(i);fullMoveHistory.push({index:i,player:p});if(p==='X'){playerMoveCount.X++;if(firstPlayerMoveIndex===-1)firstPlayerMoveIndex=i;}else playerMoveCount.O++;audioManager.play('place'); haptics.vibrate('light'); const c=boardElement.children[i];c.innerHTML='';const pion=document.createElement('span');pion.className='pion placed';pion.textContent=p;c.appendChild(pion);c.classList.add(p.toLowerCase());setTimeout(()=>pion.classList.remove('placed'),500);updateGhostPiece();} function removeOldestPieceIfNeeded(){if(moveHistory.length>6){const o=moveHistory.shift();board[o]=null;const c=boardElement.children[o];const p=c.querySelector('.pion');if(p){p.classList.add('removed');setTimeout(()=>{c.innerHTML='';c.className='cell';},300);}}updateGhostPiece();} function checkWinner(){for(const l of winningConditions){const[a,b,c]=l;if(board[a]&&board[a]===board[b]&&board[a]===board[c])return{winner:board[a],line:l};}if(!board.includes(null) && moveHistory.length < 6) return {winner:'tie',line:null}; return null;} function startNewRound(preset = null){board=Array(9).fill(null);moveHistory=[];fullMoveHistory=[];playerMoveCount={X:0,O:0};firstPlayerMoveIndex=-1;currentPlayer='X';gameActive=true;Array.from(boardElement.children).forEach(c=>{c.innerHTML='';c.className='cell';});if(preset){preset.board.forEach((p,i)=>{if(p)placePiece(i,p);});currentPlayer=preset.turn;}updateStatus();updateGhostPiece(true);} function updateGhostPiece(c=false){document.querySelectorAll('.cell.ghost').forEach(e=>e.classList.remove('ghost'));if(!c&&moveHistory.length>=6){const o=moveHistory[0];if(boardElement.children[o])boardElement.children[o].classList.add('ghost');}} function switchPlayer(){if(!gameActive)return;currentPlayer=(currentPlayer==='X'?'O':'X');updateStatus();} function updateStatus(){statusElement.textContent=gameActive?`C'est √† vous de jouer`:'';statusElement.style.color=currentPlayer==='X'?'var(--x-color)':'var(--o-color)'; if (currentPlayer === 'O' && gameActive) { statusElement.textContent = `L'IA r√©fl√©chit...`; statusElement.style.color = 'var(--text-light-color)'; }} function getEasyMove(){let a=board.map((c,i)=>c===null?i:null).filter(v=>v!==null);return a.length?a[Math.floor(Math.random()*a.length)]:-1;} function getIntermediateMove(){for(let p of['O','X']){for(let i=0;i<9;i++){if(!board[i]){board[i]=p;if(checkWinner()){board[i]=null;return i;}board[i]=null;}}}return getEasyMove();} function getHardMove(){return minimax(board,'O').index;} function minimax(b,p){let a=b.map((c,i)=>c===null?i:null).filter(v=>v!==null);let w=checkWinnerForBoard(b);if(w)return{score:w.winner==='O'?10:-10};if(a.length===0)return{score:0};let m=[];for(let i of a){let o={index:i};b[i]=p;o.score=minimax(b,p==='O'?'X':'O').score;b[i]=null;m.push(o);}let bm;if(p==='O'){let bs=-Infinity;for(let o of m){if(o.score>bs){bs=o.score;bm=o;}}}else{let bs=Infinity;for(let o of m){if(o.score<bs){bs=o.score;bm=o;}}}return bm;} function checkWinnerForBoard(b){for(const l of winningConditions){const[x,y,z]=l;if(b[x]&&b[x]===b[y]&&b[x]===b[z])return{winner:b[x]};}return null;}
        
        init();
    });
    
    // Service Worker pour le mode hors-ligne
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker enregistr√© avec succ√®s !');
        }).catch(err => {
          console.log('√âchec de l\'enregistrement du ServiceWorker: ', err);
        });
      });
    }
    </script>
</body>
</html>
